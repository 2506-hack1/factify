name: ğŸš€ Super Fast CI/CD Pipeline

on:
  push:
    branches:
      - main
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯ç”¨
  pull_request:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-1
  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–ç”¨
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '22'

jobs:
  # ğŸ” å¤‰æ›´æ¤œå‡ºã‚¸ãƒ§ãƒ–ï¼ˆä¸¦åˆ—å®Ÿè¡Œã®æœ€é©åŒ–ç”¨ï¼‰
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      infra-changed: ${{ steps.changes.outputs.infra }}
      webapp-changed: ${{ steps.changes.outputs.webapp }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            api:
              - 'api/**'
            infra:
              - 'infra/**'
              - '.github/workflows/**'
            webapp:
              - 'webapp/**'
      
      - name: ğŸ” Debug change detection results
        run: |
          echo "API changed: ${{ steps.changes.outputs.api }}"
          echo "Infra changed: ${{ steps.changes.outputs.infra }}"
          echo "Webapp changed: ${{ steps.changes.outputs.webapp }}"

  # âš¡ ä¸¦åˆ—ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–
  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infra-changed == 'true' || needs.detect-changes.outputs.api-changed == 'true' || contains(github.event.head_commit.message, 'cicd') || contains(github.event.head_commit.message, 'workflow')
    permissions:
      id-token: write
      contents: read
    outputs:
      api-endpoint: ${{ steps.get-api-endpoint.outputs.api_endpoint }}

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-cdk-deploy-session

      - name: ğŸ Setup Python with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: âš¡ Install CDK CLI (cached)
        run: npm install -g aws-cdk

      - name: ğŸ’¾ Cache Python virtual environment
        uses: actions/cache@v4
        with:
          path: infra/.venv
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('infra/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: ğŸ—ï¸ Install CDK dependencies (optimized)
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
        working-directory: ./infra

      - name: ğŸš€ CDK Deploy (with dependency order)
        env:
          DOCKER_BUILDKIT: 1
        run: |
          source .venv/bin/activate
          echo "ğŸš€ Starting CDK deployment..."
          
          # CDK bootstrapãŒå¿…è¦ãªå ´åˆã®ãƒã‚§ãƒƒã‚¯
          if ! cdk ls > /dev/null 2>&1; then
            echo "ğŸ”§ CDK bootstrap required..."
            cdk bootstrap
          fi
          
          echo "ğŸ“‹ Available stacks:"
          cdk ls
          
          # ä¾å­˜é–¢ä¿‚é †åºã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ--allã¯ä½¿ã‚ãªã„ï¼‰
          echo "ğŸ—ï¸ Deploying foundation stacks..."
          cdk deploy CognitoAuthStack DbStorageStack OpenSearchStack --require-approval never --progress events --no-version-reporting
          
          echo "ğŸ—ï¸ Deploying FastAPI stack..."
          cdk deploy FastapiFargateCdkStack --require-approval never --progress events --no-version-reporting
          
          echo "ğŸ—ï¸ Deploying CloudFront stack..."
          cdk deploy S3CloudFrontStack --require-approval never --progress events --no-version-reporting
          
          echo "âœ… All stacks deployed successfully!"
        working-directory: ./infra

      - name: ğŸŒ Get API endpoint from ECS service
        id: get-api-endpoint
        run: |
          # ECSã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—
          SERVICE_ARN=$(aws ecs list-services --cluster fastapi-cluster --query 'serviceArns[0]' --output text)
          TASK_ARN=$(aws ecs list-tasks --cluster fastapi-cluster --service-name "$SERVICE_ARN" --query 'taskArns[0]' --output text)
          PUBLIC_IP=$(aws ecs describe-tasks --cluster fastapi-cluster --tasks "$TASK_ARN" --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' --output text | xargs -I {} aws ec2 describe-network-interfaces --network-interface-ids {} --query 'NetworkInterfaces[0].Association.PublicIp' --output text)
          echo "api_endpoint=http://$PUBLIC_IP" >> $GITHUB_OUTPUT

  # ğŸŒ Webã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  deploy-webapp:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-infrastructure]
    if: needs.detect-changes.outputs.webapp-changed == 'true' || needs.detect-changes.outputs.api-changed == 'true' || contains(github.event.head_commit.message, 'cicd') || contains(github.event.head_commit.message, 'workflow')
    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-webapp-deploy-session

      - name: ğŸ“¦ Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: webapp/package-lock.json

      - name: âš¡ Install webapp dependencies (optimized)
        run: npm ci --prefer-offline --no-audit
        working-directory: ./webapp

      - name: ğŸ—ï¸ Build webapp with API endpoint
        env:
          VITE_API_ENDPOINT: ${{ needs.deploy-infrastructure.outputs.api-endpoint }}
        run: npm run build
        working-directory: ./webapp

      - name: ğŸš€ Deploy to S3 and invalidate CloudFront
        run: |
          # Get S3 bucket name and CloudFront distribution ID from CDK outputs
          BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name S3CloudFrontStack --query 'Stacks[0].Outputs[?OutputKey==`WebsiteBucketName`].OutputValue' --output text)
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks --stack-name S3CloudFrontStack --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' --output text)
          
          # Upload files to S3 (parallel)
          aws s3 sync ./webapp/dist/ s3://$BUCKET_NAME --delete --cli-write-timeout 0 --cli-read-timeout 0
          
          # Invalidate CloudFront cache (non-blocking)
          aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*" &

  # ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  test-api:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: always() && needs.deploy-infrastructure.result == 'success'

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Test API Health
        run: |
          echo "Testing API at: ${{ needs.deploy-infrastructure.outputs.api-endpoint }}"
          # Wait for service to be ready
          sleep 60
          curl -f "${{ needs.deploy-infrastructure.outputs.api-endpoint }}/health" || exit 1
          echo "âœ… API is healthy!"

      - name: ğŸ“Š Performance Test
        run: |
          # Simple performance check
          time curl -s "${{ needs.deploy-infrastructure.outputs.api-endpoint }}/health"
